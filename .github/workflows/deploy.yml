name: Deploy to AWS Lambda

on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master
  workflow_dispatch:

env:
  GO_VERSION: '1.21'
  AWS_REGION: ${{ secrets.AWS_REGION || 'us-east-1' }}

jobs:
  test:
    name: Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Download dependencies
        run: go mod download

      - name: Run tests
        run: go test -v -race -coverprofile=coverage.out ./...

      - name: Check code formatting
        run: |
          if [ "$(gofmt -s -l . | wc -l)" -gt 0 ]; then
            echo "Code is not formatted. Run 'go fmt ./...'"
            gofmt -s -l .
            exit 1
          fi

      - name: Run go vet
        run: go vet ./...

  build:
    name: Build and Package
    runs-on: ubuntu-latest
    needs: test
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Download dependencies
        run: go mod download

      - name: Build Lambda binary
        run: make build

      - name: Package Lambda function
        run: make package

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: lambda-package
          path: bootstrap.zip
          retention-days: 7

  deploy:
    name: Deploy to AWS
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/master' && github.event_name == 'push'
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # Need previous commit to detect changes

      - name: Check what changed
        id: changes
        run: |
          # Check if terraform files changed
          if git diff --name-only HEAD~1 HEAD | grep -q '^terraform/'; then
            echo "terraform_changed=true" >> $GITHUB_OUTPUT
            echo "Terraform files changed - will run full terraform apply"
          else
            echo "terraform_changed=false" >> $GITHUB_OUTPUT
            echo "Only code changed - will update Lambda function directly"
          fi

      - name: Download Lambda package
        uses: actions/download-artifact@v4
        with:
          name: lambda-package

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      # Fast path: Only update Lambda code if terraform didn't change
      - name: Update Lambda function code
        if: steps.changes.outputs.terraform_changed == 'false'
        run: |
          echo "Updating Lambda function code only..."
          aws lambda update-function-code \
            --function-name finEdSkywalker-api \
            --zip-file fileb://bootstrap.zip \
            --no-cli-pager
          echo "Waiting for function update to complete..."
          aws lambda wait function-updated \
            --function-name finEdSkywalker-api
          echo "Lambda function updated successfully!"

      # Full path: Run terraform if infrastructure changed
      - name: Set up Terraform
        if: steps.changes.outputs.terraform_changed == 'true'
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ~> 1.0
          terraform_wrapper: false

      - name: Terraform Init
        if: steps.changes.outputs.terraform_changed == 'true'
        working-directory: terraform
        run: terraform init

      - name: Terraform Plan
        if: steps.changes.outputs.terraform_changed == 'true'
        working-directory: terraform
        run: terraform plan -no-color
        continue-on-error: true

      - name: Terraform Apply
        if: steps.changes.outputs.terraform_changed == 'true'
        working-directory: terraform
        run: terraform apply -auto-approve

      - name: Get API Gateway URL
        id: get_url
        run: |
          # Try to get URL from terraform output first
          if [ -d "terraform/.terraform" ]; then
            cd terraform && terraform init -backend=false > /dev/null 2>&1 || true
            API_URL=$(terraform output -raw api_gateway_url 2>/dev/null || echo "")
          fi
          
          # Fallback: get URL from API Gateway directly
          if [ -z "$API_URL" ]; then
            API_ID=$(aws apigatewayv2 get-apis --query "Items[?Name=='finEdSkywalker-api-gateway'].ApiId" --output text)
            if [ -n "$API_ID" ]; then
              API_URL="https://${API_ID}.execute-api.${AWS_REGION}.amazonaws.com"
            fi
          fi
          
          echo "API_URL=$API_URL" >> $GITHUB_OUTPUT
          echo "API Gateway URL: $API_URL"
          echo "::notice title=API Gateway URL::$API_URL"

      - name: Test Deployment
        run: |
          API_URL="${{ steps.get_url.outputs.API_URL }}"
          if [ -z "$API_URL" ]; then
            echo "Warning: Could not determine API URL"
            exit 0
          fi
          echo "Testing health endpoint: $API_URL/health"
          sleep 5  # Give Lambda a moment to be ready
          curl -f -s "$API_URL/health" || exit 1
          echo "Deployment test successful!"

